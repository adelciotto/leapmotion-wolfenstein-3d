Wolf.Game=function(){function e(e,o){var n,t,l,a=!1,r=!1,s=!1,i=!1,u=!1,f=!1,c=-1;e.cmd.buttons=0,e.cmd.forwardMove=0,e.cmd.sideMove=0,s=Wolf.Input.checkKeys(Q.left),i=Wolf.Input.checkKeys(Q.right),u=Wolf.Input.checkKeys(Q.down),f=Wolf.Input.checkKeys(Q.up),a=Wolf.Input.checkKeys(Q.run),r=Wolf.Input.checkKeys(Q.strafe),n=a?Wolf.RUNMOVE:Wolf.BASEMOVE,(Wolf.Input.checkKeys(Q.attack)||V&&Wolf.Input.leftMouseDown()||q&&Wolf.Input.thumbContracting())&&(e.cmd.buttons|=Wolf.BUTTON_ATTACK),V&&Wolf.Input.rightMouseDown()?(l=Wolf.Input.getMouseCoords())&&(e.cmd.forwardMove+=-(l.y<0?Wolf.MOVESCALE:Wolf.BACKMOVESCALE)*n*l.y):f&&u||(f&&(e.cmd.forwardMove+=n*Wolf.MOVESCALE),u&&(e.cmd.forwardMove+=-n*Wolf.BACKMOVESCALE)),V&&Wolf.Input.isPointerLocked()?(t=Wolf.Input.getMouseMovement(),e.angle-=t.x*Wolf.TURNANGLESCALE*o>>0):q?(e.angle-=Wolf.Input.getHandMovement()*Wolf.LEAPTURNANGLESCALE*o>>0,s&&(e.cmd.sideMove+=-n*Wolf.MOVESCALE),i&&(e.cmd.sideMove+=n*Wolf.MOVESCALE)):(s&&(r?e.cmd.sideMove+=-n*Wolf.MOVESCALE:e.angle+=Wolf.TURNANGLESCALE*o),i&&(r?e.cmd.sideMove+=n*Wolf.MOVESCALE:e.angle-=Wolf.TURNANGLESCALE*o),V&&(l=Wolf.Input.getMouseCoords())&&Math.abs(l.x)>Wolf.MOUSEDEADBAND&&(e.angle-=Wolf.TURNANGLESCALE*o*(l.x+(l.x<0?1:-1)*Wolf.MOUSEDEADBAND)>>0)),Wolf.Input.checkKeys(Q.weapon1)&&e.items&Wolf.ITEM_WEAPON_1?c=Wolf.WEAPON_KNIFE:Wolf.Input.checkKeys(Q.weapon2)&&e.items&Wolf.ITEM_WEAPON_2&&e.ammo[Wolf.AMMO_BULLETS]?c=Wolf.WEAPON_PISTOL:Wolf.Input.checkKeys(Q.weapon3)&&e.items&Wolf.ITEM_WEAPON_3&&e.ammo[Wolf.AMMO_BULLETS]?c=Wolf.WEAPON_AUTO:Wolf.Input.checkKeys(Q.weapon4)&&e.items&Wolf.ITEM_WEAPON_4&&e.ammo[Wolf.AMMO_BULLETS]&&(c=Wolf.WEAPON_CHAIN),c>-1&&(e.previousWeapon=Wolf.WEAPON_KNIFE,e.weapon=e.pendingWeapon=c),(Wolf.Input.checkKeys(Q.use)||q&&Wolf.Input.handClenching())&&(e.cmd.buttons|=Wolf.BUTTON_USE)}function o(o){function l(){if(U&&(K=setTimeout(l,1e3/30),B++,!z)){var u,f,c=o.player,m=o.level,d=r();if(c.playstate!=Wolf.ex_dead)e(c,d),c.angle=Wolf.Math.normalizeAngle(c.angle),Wolf.Player.process(o,c,d),X&&Wolf.Actors.process(o,d),Wolf.PushWall.process(m,d),Wolf.Doors.process(m,c,d);else if(n(o,d))if(a+=d,a>=s){if(a=0,$("#game .renderer .death").css("display","none"),!(o.player.lives>0))return void t(o);u=o.player.lives,f=o.player.startScore,o.level=Wolf.Level.reload(m),Wolf.Level.scanInfoPlane(o.level,o.skill),o.player=Wolf.Player.spawn(o.level.spawn,o.level,o.skill),o.player.lives=u-1,o.player.score=f,o.player.startScore=f,o.level.state.startTime=(new Date).getTime(),o.level.state.elapsedTime=0}else $("#game .renderer .death").css({display:"block",backgroundColor:"rgba(255,0,0,"+a/s+")"});Wolf.Sprites.clean(m),i(o,d)}}var a=0,s=2*ee;K&&(clearTimeout(K),K=0),oe=(new Date).getTime(),l()}function n(e,o){var n,t,l,a,r,s,i,u,f=e.player,c=f.lastAttacker;if(t=c.x-f.position.x,l=f.position.y-c.y,n=-Math.atan2(l,t),0>n&&(n=2*Math.PI+n),a=Math.round(n/(2*Math.PI)*Wolf.ANGLES),r=Wolf.FINE2DEG(f.angle),r>a?(i=r-a,s=Wolf.ANGLES-r+a):(s=a-r,i=r+Wolf.ANGLES-a),i>s){if(r>a&&(r-=Wolf.ANGLES),r==a)return!0;u=o*Wolf.DEATHROTATE,r+u>a&&(u=a-r),r+=u,r>=Wolf.ANGLES&&(r-=Wolf.ANGLES),f.angle=Wolf.DEG2FINE(r)}else{if(a>r&&(r+=Wolf.ANGLES),r==a)return!0;u=-o*Wolf.DEATHROTATE,a>r+u&&(u=a-r),r+=u,0>r&&(r+=Wolf.ANGLES),f.angle=Wolf.DEG2FINE(r)}return!1}function t(e){function o(){$(document).off("keydown",n),$("#game").fadeOut(null,function(){$("#game .gameover").hide(),Wolf.Menu.show()})}function n(e){return $("#game .gameover").is(":visible")?void((13==e.keyCode||32==e.keyCode)&&o()):void o()}U=!1,P=!1,$("#game .renderer").hide(),$("#game .fps").hide(),$("#game .gameover").show(),W(),$(document).on("keydown",n)}function l(e){e.player.playstate!=Wolf.ex_victory&&(Y=!1,Wolf.log("Victory!"),$("#game .renderer .player-weapon").hide(),Wolf.Actors.spawnBJVictory(e.player,e.level,e.skill),e.player.playstate=Wolf.ex_victory)}function a(e){Wolf.Game.startIntermission(e)}function r(){var e=(new Date).getTime(),o=(e-oe)/1e3,n=Math.floor(ee*o);return oe+=1e3*n/ee>>0,n}function s(e,o){for(var n=$("#game .hud ."+e+" .number"),t=n.length-1;t>=0;t--)0==o&&t<n.length-1?n[t].style.backgroundPosition="16px 0":(n[t].style.backgroundPosition=-(16*(o%10))+"px 0",o=o/10>>0)}function i(e,o){var n=e.player,t=4*n.weapon+n.weaponFrame;n.playstate==Wolf.ex_dead||n.playstate==Wolf.ex_victory?$("#game .renderer .player-weapon").css("display","none"):$("#game .renderer .player-weapon").css({display:"block",backgroundPosition:-(t*Wolf.HUD_WEAPON_WIDTH)+"px 0"}),$("#game .hud .weapon").css({backgroundPosition:-(96*n.weapon)+"px 0"}),$("#game .hud .key1").css({display:n.items&Wolf.ITEM_KEY_1?"block":"none"}),$("#game .hud .key2").css({display:n.items&Wolf.ITEM_KEY_2?"block":"none"}),s("ammo",n.ammo[Wolf.AMMO_BULLETS]),s("health",n.health),s("lives",n.lives),s("score",n.score),s("floor",e.levelNum+1),f(n,o)}function u(e){var o=e.player,n=e.level,t={x:o.position.x,y:o.position.y,angle:o.angle},l=Wolf.Raycaster.traceRays(t,n);Wolf.Renderer.clear(),Wolf.Renderer.draw(t,n,l.tracers,l.visibleTiles)}function f(e,o){var n;if(e.faceCount+=o,e.faceGotGun&&e.faceCount>0&&(e.faceGotGun=!1),e.faceCount>Wolf.Random.rnd()&&(e.faceGotGun=e.faceOuch=!1,e.faceFrame=Wolf.Random.rnd()>>6,3==e.faceFrame&&(e.faceFrame=0),e.faceCount=0),e.health)if(e.faceGotGun)n=22;else{var t=e.health;t>100&&(t=100),0>t&&(t=0),n=(3*((100-t)/16)>>0)+e.faceFrame,e.flags&Wolf.FL_GODMODE&&(n=23+e.faceFrame)}else n=21;$("#game .hud .bj").css({backgroundPosition:-(n*Wolf.HUD_FACE_WIDTH)+"px 0"})}function c(e){function o(){P&&(z||u(e),G=requestAnimationFrame(o),x++)}G&&(cancelAnimationFrame(G),G=0),Wolf.Renderer.init(),$("#game .renderer").show(),P=!0,o()}function m(e,n,t){if(Wolf.Episodes[n].enabled){U=!1,P=!1,e.episodeNum=n,e.levelNum=t;var l=Wolf.Episodes[e.episodeNum];Wolf.Level.load(l.levels[e.levelNum].file,function(n,t){if(n)throw n;$("#game .renderer .floor").css({"background-color":"rgb("+t.floor[0]+","+t.floor[1]+","+t.floor[2]+")"}),$("#game .renderer .ceiling").css({"background-color":"rgb("+t.ceiling[0]+","+t.ceiling[1]+","+t.ceiling[2]+")"}),e.level=t,D=t.music,Wolf.Level.scanInfoPlane(t,e.skill),$("#game .loading").show(),d(t,function(){Wolf.Sound.startMusic(t.music),e.player=Wolf.Player.spawn(t.spawn,t,e.skill,e.player),e.player.startScore=e.player.score,t.state.startTime=(new Date).getTime(),t.state.elapsedTime=0,U=!0,o(e),c(e),Wolf.Input.reset(),Wolf.Input.lockPointer(),$("#game .loading").hide(),$("#game").focus(),$("#game .renderer .player-weapon").show(),Y=!0})})}}function d(e,o){function n(e){e>0&&(e%2==0&&e--,a=i+"w_"+e+".png",J[a]||(s.push(a),J[a]=!0))}var t,l,a,r,s=[],i="art/walls-shaded/"+Wolf.TEXTURERESOLUTION+"/",u="art/sprites/"+Wolf.TEXTURERESOLUTION+"/";for(t=0;64>t;++t)for(l=0;64>l;++l)n(e.wallTexX[t][l]),n(e.wallTexY[t][l]);for(a=u+"002_053.png",Z[a]||(s.push(a),Z[a]=!0),r=0;r<s.length;++r)s[r]="preload!timeout=5!"+s[r];s.length?Modernizr.load({load:s,complete:o}):o()}function g(e){L()&&(W(),D=null,Wolf.Sound.stopAllSounds()),$("#game .renderer .death").hide(),$("#game .renderer .damage-flash").hide(),$("#game .renderer .bonus-flash").hide(),$("#game").show();var o={episode:-1,level:-1,skill:e,killRatios:[],secretRatios:[],treasureRatios:[],totalTime:0};return j=o,o}function W(){K&&(clearTimeout(K),K=0),G&&(cancelAnimationFrame(G),G=0),U=!1,P=!1,Wolf.Renderer.reset(),z&&O()}function p(e){W(),$("#game").fadeOut(null,function(){var o="victory"+(e.episodeNum+1),n=2==e.episodeNum?1:2;Wolf.Menu.showText(o,n,function(){Wolf.Menu.show("main")})})}function h(e,o){function n(){var e=(new Date).getTime(),o=Math.floor(e/500)%2;$("#game .intermission .bj").css({backgroundPosition:-(162*o)+"px 0px"}),H=requestAnimationFrame(n)}function t(){H&&(cancelAnimationFrame(H),H=0),$(document).off("keydown",l),$("#game .intermission").hide()}function l(o){var n;if(!$("#game .intermission").is(":visible"))return void t();if(13==o.keyCode||32==o.keyCode){if(t(),e.player.playstate==Wolf.ex_secretlevel)n=9;else{if(8==e.levelNum)return void $("#game").fadeOut(1e3,function(){p(e)});if(9==e.levelNum)switch(e.episodeNum){case 0:n=1;break;case 1:n=1;break;case 2:n=7;break;case 3:n=3;break;case 4:n=4;break;case 5:n=3;break;default:n=e.levelNum+1}else n=e.levelNum+1}Wolf.Player.givePoints(e.player,u),m(e,e.episodeNum,n)}}var a,r,s=Wolf.Episodes[e.episodeNum],i=60*s.levels[e.levelNum].partime,u=0,f=500,c=1e4,d=e.level.state,g=d.totalMonsters?d.killedMonsters/d.totalMonsters*100>>0:0,W=d.totalSecrets?d.foundSecrets/d.totalSecrets*100>>0:0,h=d.totalTreasure?d.foundTreasure/d.totalTreasure*100>>0:0,v=d.elapsedTime+((new Date).getTime()-d.startTime),y=0,w=0,A=0;if(U=!1,Wolf.Sound.startMusic("music/URAHERO.ogg"),$("#game .renderer").hide(),$("#game .fps").hide(),$("#game .intermission .digit").hide(),$("#game .intermission").show(),$("#game .intermission .background").hide(),$("#game .intermission .background-secret").hide(),$("#game .intermission .background-victory").hide(),$("#game .intermission .stat").hide(),$("#game .intermission .victory-stat").hide(),$("#game .intermission .bj").hide(),v=Math.min(5940,Math.round(v/1e3)),g=Math.min(g,100),W=Math.min(W,100),h=Math.min(h,100),e.killRatios.push(g),e.secretRatios.push(W),e.treasureRatios.push(h),e.totalTime+=v,9==e.levelNum)$("#game .intermission .background-secret").show(),$("#game .intermission .bj").show(),u=15e3;else if(8==e.levelNum){for($("#game .intermission .background-victory").show(),$("#game .intermission .victory-stat").show(),a=Math.min(5940,e.totalTime),r=0;r<e.killRatios.length;r++)y+=e.killRatios[r];for(r=0;r<e.secretRatios.length;r++)w+=e.secretRatios[r];for(r=0;r<e.treasureRatios.length;r++)A+=e.treasureRatios[r];y=Math.round(y/e.killRatios.length),w=Math.round(w/e.secretRatios.length),A=Math.round(A/e.treasureRatios.length),E("total-time-minutes",a/60>>0,!0),E("total-time-seconds",a/60%1*60,!0),E("avg-kill-ratio",y,!1),E("avg-secret-ratio",w,!1),E("avg-treasure-ratio",A,!1)}else $("#game .intermission .background").show(),$("#game .intermission .bj").show(),$("#game .intermission .stat").show(),i&&i>v&&(u+=(i-v)*f),100==g&&(u+=c),100==W&&(u+=c),100==h&&(u+=c),v/=60,i/=60,E("floor",e.levelNum+1,!1),E("bonus",u,!1),E("time-minutes",v>>0,!0),E("time-seconds",v%1*60,!0),E("par-minutes",i>>0,!0),E("par-seconds",i%1*60,!0),E("kill-ratio",g,!1),E("secret-ratio",W,!1),E("treasure-ratio",h,!1);8!=e.levelNum&&(H||n()),$(document).on("keydown",l)}function E(e,o,n){var t,l,a,r=$("#game .intermission ."+e+" .digit");for(t=0;10>t;t++)r.removeClass("num-"+t);for(o>>=0,a=o,t=0;t<r.length;t++)l=a%10,(a>0||n||0==o&&0==t)&&r.eq(r.length-1-t).addClass("num-"+l),a=a/10>>0;r.show()}function v(){$("#game .renderer .damage-flash").show().fadeOut(300)}function y(){$("#game .renderer .bonus-flash").show().fadeOut(300)}function w(e){Wolf.log(e)}function A(){return"webkitIsFullScreen"in document?document.webkitIsFullScreen:"mozFullScreen"in document?document.mozFullScreen:$("#main").data("scale")>1?!0:!1}function M(e){A()?k():S()}function T(){var e=$("#main")[0];if(A()){if(document.exitFullscreen)return document.exitFullscreen(),!0;if(document.webkitCancelFullscreen)return document.webkitCancelFullscreen(),!0;if(document.mozCancelFullscreen)return document.mozCancelFullscreen(),!0}else{if(e.requestFullScreenWithKeys)return e.requestFullScreenWithKeys(),!0;if(e.requestFullScreen)return e.requestFullScreen(!0),!0;if(e.webkitRequestFullScreen)return e.webkitRequestFullScreen(!0),!0;if(document.body.mozRequestFullScreenWithKeys)return document.body.mozRequestFullScreenWithKeys(),!0;if(document.body.mozRequestFullScreen)return document.body.mozRequestFullScreen(),!0}return!1}function k(){var e=window.innerWidth/640,o=Math.floor(Wolf.SLICE_WIDTH*e),n=o/Wolf.SLICE_WIDTH,t="scale("+n+")";$("#main").css({transform:t,"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t}).data("scale",n)}function S(){$("#main").css({transform:"","-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":""}).data("scale",1)}function N(){$(document).on("mozfullscreenchange",M).on("webkitfullscreenchange",M).on("fullscreenchange",M),Wolf.Input.bindKey("F11",function(e){Y&&(T()?e.preventDefault():A()?S():k())}),Wolf.Input.bindKey("P",function(e){Y&&O()}),Wolf.Input.bindKey("ESC",function(e){Y&&b()}),!A()&&(window.fullScreen||window.innerWidth==screen.width&&window.innerHeight==screen.height)&&T()}function b(){z||O(),$("#game").hide(),Y=!1,Wolf.Menu.show("main")}function I(){$("#game").show(),z&&O(),Y=!0,D&&Wolf.Sound.startMusic(D)}function L(){return U}function O(){z=!z,z?Wolf.Sound.pauseMusic(!0):(Wolf.Sound.pauseMusic(!1),oe=(new Date).getTime()),$("#game .renderer div.pause.overlay").toggle(z)}function C(e){V=e}function R(){return V}function _(){var e={};for(var o in Q)Q.hasOwnProperty(o)&&(e[o]=Q[o]);return e}function F(e,o){Q[e]=o}Wolf.setConsts({BUTTON_ATTACK:1,BUTTON_USE:2,BUTTON_ANY:128,BASEMOVE:35,RUNMOVE:70,MOVESCALE:150,BACKMOVESCALE:100,MAXMOUSETURN:10,TURNANGLESCALE:300,LEAPTURNANGLESCALE:220,MOUSEDEADBAND:.2,LEAPDEADBAND:.3,gd_baby:0,gd_easy:1,gd_medium:2,gd_hard:3});var D,P=!1,U=!1,G=0,K=0,x=0,B=0,V=!1,q=!0,z=!1,H=0,j=null,X=!0,Y=!1,J={},Z={},Q={up:["W"],left:["A"],down:["S"],right:["D"],run:["SHIFT"],attack:["X"],use:["SPACE"],strafe:["Z"],weapon1:["1"],weapon2:["2"],weapon3:["3"],weapon4:["4"]},ee=70,oe=0;return{startGame:g,startLevel:m,startIntermission:h,startDamageFlash:v,startBonusFlash:y,enableMouse:C,isMouseEnabled:R,isPlaying:L,notify:w,isFullscreen:A,init:N,getControls:_,bindControl:F,toggleFullscreen:T,resume:I,victory:l,endEpisode:a}}();