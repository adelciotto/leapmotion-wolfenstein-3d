Wolf.Level=function(){function e(){return{areas:[],tileMap:[],wallTexX:[],wallTexY:[],spawn:{x:-1,y:-1,angle:0},sprites:[],floorNum:0,fParTime:0,sParTime:"",levelName:"",mapName:"",nextMap:"",music:"",state:{framenum:0,time:0,levelCompleted:0,totalSecrets:0,foundSecrets:0,totalTreasure:0,foundTreasure:0,totalMonsters:0,killedMonsters:0,areaconnect:null,areabyplayer:null,numDoors:0,doors:[],doorMap:[],powerups:[],numPowerups:0,guards:[],numGuards:0,startTime:0,elapsedTime:0}}}function a(a){var s,l,r,f,W,c,t,n,S,i,T=Wolf.File,p=e();if(a.position=0,p.file=a,a.size<Wolf.MAPHEADER_SIZE)throw new Error("Map file size is smaller than mapheader size");if(T.readUInt32(a)!=Wolf.MAP_SIGNATURE)throw new Error("File signature does not match MAP_SIGNATURE");if(rle=T.readUInt16(a),p.width=T.readUInt16(a),p.height=T.readUInt16(a),p.ceiling=[T.readUInt8(a),T.readUInt8(a),T.readUInt8(a),T.readUInt8(a)],p.floor=[T.readUInt8(a),T.readUInt8(a),T.readUInt8(a),T.readUInt8(a)],s=[T.readUInt16(a),T.readUInt16(a),T.readUInt16(a)],l=[T.readUInt32(a),T.readUInt32(a),T.readUInt32(a)],r=T.readUInt16(a),f=T.readUInt16(a),a.position+=4,p.sParTime=T.readString(a,5),a.size<Wolf.MAPHEADER_SIZE+r+f+s[0]+s[1]+s[2])throw new Error("filesize is less than MAPHEADER_SIZE + mapNameLength + musicNameLength + etc");for(p.levelName=p.mapName=T.readString(a,r),p.music=T.readString(a,f),p.plane1=o(a,l[0],s[0],rle),p.plane2=o(a,l[1],s[1],rle),p.plane3=o(a,l[2],s[2],rle),Wolf.Doors.reset(p),W=0;64>W;W++)for(p.areas[W]=[],p.tileMap[W]=[],p.wallTexX[W]=[],p.wallTexY[W]=[],c=0;64>c;c++)p.areas[W][c]=0,p.tileMap[W][c]=0,p.wallTexX[W][c]=0,p.wallTexY[W][c]=0;for(t=0;64>t;++t)for(W=0;64>W;++W)c=63-t,n=p.plane1[64*t+W],S=p.plane2[64*t+W],i=p.plane3[64*t+W],S&&_(p,S,W,c),0==n?p.areas[W][c]=-3:106>n?n>=90&&95>=n||100==n||101==n?(p.tileMap[W][c]|=Wolf.DOOR_TILE,Wolf.Doors.spawn(p,W,c,n),p.areas[W][c]=-2):(p.tileMap[W][c]|=Wolf.WALL_TILE,p.wallTexX[W][c]=2*(n-1)+1,p.wallTexY[W][c]=2*(n-1),p.areas[W][c]=-1,21==n&&(p.tileMap[W][c]|=Wolf.ELEVATOR_TILE)):106==n?(p.tileMap[W][c]|=Wolf.AMBUSH_TILE,p.areas[W][c]=-3):n>=Wolf.FIRSTAREA&&n<Wolf.FIRSTAREA+Wolf.NUMAREAS?(n==Wolf.FIRSTAREA&&(p.tileMap[W][c]|=Wolf.SECRETLEVEL_TILE),p.areas[W][c]=n-Wolf.FIRSTAREA):p.areas[W][c]=-3;for(W=1;63>W;W++)for(c=1;63>c;c++)-3==p.areas[W][c]&&(p.areas[W-1][c]>=0?p.areas[W][c]=p.areas[W-1][c]:p.areas[W+1][c]>=0?p.areas[W][c]=p.areas[W+1][c]:p.areas[W][c-1]>=0?p.areas[W][c]=p.areas[W][c-1]:p.areas[W+1][c+1]>=0&&(p.areas[W][c]=p.areas[W][c+1]));return Wolf.Doors.setAreas(p),p}function o(e,a,o,r){e.position=a;var f=Wolf.File.readUInt16(e),_=Wolf.File.readBytes(e,o-2),W=l(_,f);return s(W.slice(1),8192,r)}function s(e,a,o){var s,l,r,f,_=0,W=0,c=[];f=W+(a>>1);do if(s=e[_++],s!=o)c[W++]=s;else for(l=e[_++],s=e[_++],r=1;l>=r;++r)c[W++]=s;while(f>W);return c}function l(e,a){var o,s,l,r,f,_,W,c,t=167,n=168;for(a/=2,f=0,r=0,c=[];a;)if(_=e[f]+(e[f+1]<<8),f+=2,o=_>>8,o==t)if(W=255&_)for(s=e[f++],l=r-s,a-=W;W--;)c[r++]=c[l++];else _|=e[f++],c[r++]=_,a--;else if(o==n)if(W=255&_)for(s=e[f]+(e[f+1]<<8),f+=2,l=s,a-=W;W--;)c[r++]=c[l++];else _|=e[f++],c[r++]=_,a--;else c[r++]=_,a--;return c}function r(e,o){Wolf.File.open(e,Wolf.MapData,function(e,s){var l;e&&o(e);try{l=a(s)}catch(e){return void o(e)}o(null,l)})}function f(e){return a(e.file)}function _(e,a,o,s){if(a>=23&&a<23+n.length)return void W(e,a-23,o,s);switch(a){case 19:e.spawn.x=Wolf.TILE2POS(o),e.spawn.y=Wolf.TILE2POS(s),e.spawn.angle=Wolf.ANG_90;break;case 20:e.spawn.x=Wolf.TILE2POS(o),e.spawn.y=Wolf.TILE2POS(s),e.spawn.angle=Wolf.ANG_0;break;case 21:e.spawn.x=Wolf.TILE2POS(o),e.spawn.y=Wolf.TILE2POS(s),e.spawn.angle=Wolf.ANG_270;break;case 22:e.spawn.x=Wolf.TILE2POS(o),e.spawn.y=Wolf.TILE2POS(s),e.spawn.angle=Wolf.ANG_180;break;case 90:e.tileMap[o][s]|=Wolf.TILE_IS_E_TURN;break;case 91:e.tileMap[o][s]|=Wolf.TILE_IS_NE_TURN;break;case 92:e.tileMap[o][s]|=Wolf.TILE_IS_N_TURN;break;case 93:e.tileMap[o][s]|=Wolf.TILE_IS_NW_TURN;break;case 94:e.tileMap[o][s]|=Wolf.TILE_IS_W_TURN;break;case 95:e.tileMap[o][s]|=Wolf.TILE_IS_SW_TURN;break;case 96:e.tileMap[o][s]|=Wolf.TILE_IS_S_TURN;break;case 97:e.tileMap[o][s]|=Wolf.TILE_IS_SE_TURN;break;case 98:e.tileMap[o][s]|=Wolf.SECRET_TILE,e.state.totalSecrets++;break;case 99:e.tileMap[o][s]|=Wolf.EXIT_TILE}}function W(e,a,o,s){var l,r;if(-1==n[a].powerup){if(n[a].block?e.tileMap[o][s]|=Wolf.BLOCK_TILE:e.tileMap[o][s]|=Wolf.DRESS_TILE,l=Wolf.Sprites.getNewSprite(e),!l)return;Wolf.Sprites.setPos(e,l,Wolf.TILE2POS(o),Wolf.TILE2POS(s),0),Wolf.Sprites.setTex(e,l,0,Wolf.SPR_STAT_0+a)}else r=n[a].powerup,Wolf.Powerups.spawn(e,o,s,r),(r==Wolf.pow_cross||r==Wolf.pow_chalice||r==Wolf.pow_bible||r==Wolf.pow_crown||r==Wolf.pow_fullheal)&&e.state.totalTreasure++}function c(e,a){var o,s,l;for(T=0,p=0,E=0,I=0,R=0,L=0,s=0;64>s;++s)for(o=0;64>o;++o)if(l=e.plane2[64*(63-s)+o])switch(l){case 180:case 181:case 182:case 183:if(a<Wolf.gd_hard)break;l-=36;case 144:case 145:case 146:case 147:if(a<Wolf.gd_medium)break;l-=36;case 108:case 109:case 110:case 111:T||(Wolf.Sprites.cacheTextures(Wolf.SPR_GRD_S_1,Wolf.SPR_GRD_SHOOT3),T=1),Wolf.Actors.spawnStand(e,a,Wolf.en_guard,o,s,l-108);break;case 184:case 185:case 186:case 187:if(a<Wolf.gd_hard)break;l-=36;case 148:case 149:case 150:case 151:if(a<Wolf.gd_medium)break;l-=36;case 112:case 113:case 114:case 115:T||(Wolf.Sprites.cacheTextures(Wolf.SPR_GRD_S_1,Wolf.SPR_GRD_SHOOT3),T=1),Wolf.Actors.spawnPatrol(e,a,Wolf.en_guard,o,s,l-112);break;case 124:Wolf.Actors.spawnDeadGuard(e,a,Wolf.en_guard,o,s);break;case 188:case 189:case 190:case 191:if(a<Wolf.gd_hard)break;l-=36;case 152:case 153:case 154:case 155:if(a<Wolf.gd_medium)break;l-=36;case 116:case 117:case 118:case 119:p||(Wolf.Sprites.cacheTextures(Wolf.SPR_OFC_S_1,Wolf.SPR_OFC_SHOOT3),p=1),Wolf.Actors.spawnStand(e,a,Wolf.en_officer,o,s,l-116);break;case 192:case 193:case 194:case 195:if(a<Wolf.gd_hard)break;l-=36;case 156:case 157:case 158:case 159:if(a<Wolf.gd_medium)break;l-=36;case 120:case 121:case 122:case 123:p||(Wolf.Sprites.cacheTextures(Wolf.SPR_OFC_S_1,Wolf.SPR_OFC_SHOOT3),p=1),Wolf.Actors.spawnPatrol(e,a,Wolf.en_officer,o,s,l-120);break;case 198:case 199:case 200:case 201:if(a<Wolf.gd_hard)break;l-=36;case 162:case 163:case 164:case 165:if(a<Wolf.gd_medium)break;l-=36;case 126:case 127:case 128:case 129:E||(Wolf.Sprites.cacheTextures(Wolf.SPR_SS_S_1,Wolf.SPR_SS_SHOOT3),E=1),Wolf.Actors.spawnStand(e,a,Wolf.en_ss,o,s,l-126);break;case 202:case 203:case 204:case 205:if(a<Wolf.gd_hard)break;l-=36;case 166:case 167:case 168:case 169:if(a<Wolf.gd_medium)break;l-=36;case 130:case 131:case 132:case 133:E||(Wolf.Sprites.cacheTextures(Wolf.SPR_SS_S_1,Wolf.SPR_SS_SHOOT3),E=1),Wolf.Actors.spawnPatrol(e,a,Wolf.en_ss,o,s,l-130);break;case 206:case 207:case 208:case 209:if(a<Wolf.gd_hard)break;l-=36;case 170:case 171:case 172:case 173:if(a<Wolf.gd_medium)break;l-=36;case 134:case 135:case 136:case 137:I||(Wolf.Sprites.cacheTextures(Wolf.SPR_DOG_W1_1,Wolf.SPR_DOG_JUMP3),I=1),Wolf.Actors.spawnStand(e,a,Wolf.en_dog,o,s,l-134);break;case 210:case 211:case 212:case 213:if(a<Wolf.gd_hard)break;l-=36;case 174:case 175:case 176:case 177:if(a<Wolf.gd_medium)break;l-=36;case 138:case 139:case 140:case 141:I||(Wolf.Sprites.cacheTextures(Wolf.SPR_DOG_W1_1,Wolf.SPR_DOG_JUMP3),I=1),Wolf.Actors.spawnPatrol(e,a,Wolf.en_dog,o,s,l-138);break;case 214:Wolf.Sprites.cacheTextures(Wolf.SPR_BOSS_W1,Wolf.SPR_BOSS_DIE3),Wolf.Actors.spawnBoss(e,a,Wolf.en_boss,o,s);break;case 197:Wolf.Sprites.cacheTextures(Wolf.SPR_GRETEL_W1,Wolf.SPR_GRETEL_DIE3),Wolf.Actors.spawnBoss(e,a,Wolf.en_gretel,o,s);break;case 215:Wolf.Sprites.cacheTextures(Wolf.SPR_GIFT_W1,Wolf.SPR_GIFT_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_gift,o,s);break;case 179:Wolf.Sprites.cacheTextures(Wolf.SPR_FAT_W1,Wolf.SPR_FAT_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_fat,o,s);break;case 196:Wolf.Sprites.cacheTextures(Wolf.SPR_SCHABB_W1,Wolf.SPR_HYPO4),Wolf.Actors.spawnBoss(e,a,Wolf.en_schabbs,o,s);break;case 160:Wolf.Sprites.cacheTextures(Wolf.SPR_FAKE_W1,Wolf.SPR_FAKE_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_fake,o,s);break;case 178:Wolf.Sprites.cacheTextures(Wolf.SPR_MECHA_W1,Wolf.SPR_HITLER_DIE7),Wolf.Actors.spawnBoss(e,a,Wolf.en_mecha,o,s);break;case 106:Wolf.Sprites.cacheTextures(Wolf.SPR_SPECTRE_W1,Wolf.SPR_SPECTRE_F4),Wolf.Actors.spawnBoss(e,a,Wolf.en_spectre,o,s);break;case 107:Wolf.Sprites.cacheTextures(Wolf.SPR_ANGEL_W1,Wolf.SPR_ANGEL_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_angel,o,s);break;case 125:Wolf.Sprites.cacheTextures(Wolf.SPR_TRANS_W1,Wolf.SPR_TRANS_DIE3),Wolf.Actors.spawnBoss(e,a,Wolf.en_trans,o,s);break;case 142:Wolf.Sprites.cacheTextures(Wolf.SPR_UBER_W1,Wolf.SPR_UBER_DEAD),Wolf.Actors.spawnBoss(e,a,olf.en_uber,o,s);break;case 143:Wolf.Sprites.cacheTextures(Wolf.SPR_WILL_W1,Wolf.SPR_WILL_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_will,o,s);break;case 161:Wolf.Sprites.cacheTextures(Wolf.SPR_DEATH_W1,Wolf.SPR_DEATH_DEAD),Wolf.Actors.spawnBoss(e,a,Wolf.en_death,o,s);break;case 252:case 253:case 254:case 255:if(a<Wolf.gd_hard)break;l-=18;case 234:case 235:case 236:case 237:if(a<Wolf.gd_medium)break;l-=18;case 216:case 217:case 218:case 219:R||(Wolf.Sprites.cacheTextures(Wolf.SPR_MUT_S_1,Wolf.SPR_MUT_SHOOT4),R=1),Wolf.Actors.spawnStand(e,a,Wolf.en_mutant,o,s,l-216);break;case 256:case 257:case 258:case 259:if(a<Wolf.gd_hard)break;l-=18;case 238:case 239:case 240:case 241:if(a<Wolf.gd_medium)break;l-=18;case 220:case 221:case 222:case 223:R||(Wolf.Sprites.cacheTextures(Wolf.SPR_MUT_S_1,Wolf.SPR_MUT_SHOOT4),R=1),Wolf.Actors.spawnPatrol(e,a,Wolf.en_mutant,o,s,l-220);break;case 224:Wolf.Sprites.cacheTextures(Wolf.SPR_BLINKY_W1,Wolf.SPR_BLINKY_W2),Wolf.Actors.spawnGhosts(e,a,Wolf.en_blinky,o,s);break;case 225:Wolf.Sprites.cacheTextures(Wolf.SPR_PINKY_W1,Wolf.SPR_PINKY_W2),Wolf.Actors.spawnGhosts(e,a,Wolf.en_clyde,o,s);break;case 226:Wolf.Sprites.cacheTextures(Wolf.SPR_CLYDE_W1,Wolf.SPR_CLYDE_W2),Wolf.Actors.spawnGhosts(e,a,Wolf.en_pinky,o,s);break;case 227:Wolf.Sprites.cacheTextures(Wolf.SPR_INKY_W1,Wolf.SPR_INKY_W2),Wolf.Actors.spawnGhosts(e,a,Wolf.en_inky,o,s)}}function t(e,a,o,s,l){var r,f,_,W,c,t,n,S,i,T,p,E,I,R,L=8;if(r=e>>Wolf.TILESHIFT,f=a>>Wolf.TILESHIFT,_=o>>Wolf.TILESHIFT,W=s>>Wolf.TILESHIFT,n=Math.abs(_-r),S=Math.abs(W-f),e>>=L,a>>=L,o>>=L,s>>=L,n){_>r?(I=256-(255&e),i=1):(I=255&e,i=-1),p=Math.abs(o-e),T=(s-a<<L)/p,E=a+(T*I>>L),c=r+i,_+=i;do{if(t=E>>L,E+=T,l.tileMap[c][t]&Wolf.WALL_TILE)return!1;if(l.tileMap[c][t]&Wolf.DOOR_TILE&&l.state.doorMap[c][t].action!=Wolf.dr_open){if(l.state.doorMap[c][t].action==Wolf.dr_closed)return!1;if(R=(E-T/2&255)>>4,R<63-l.state.doorMap[c][t].ticcount)return!1}c+=i}while(c!=_)}if(S){W>f?(I=256-(255&a),T=1):(I=255&a,T=-1),p=Math.abs(s-a),i=(o-e<<L)/p,E=e+(i*I>>L),t=f+T,W+=T;do{if(c=E>>L,E+=i,l.tileMap[c][t]&Wolf.WALL_TILE)return!1;if(l.tileMap[c][t]&Wolf.DOOR_TILE&&l.state.doorMap[c][t].action!=Wolf.dr_open){if(l.state.doorMap[c][t].action==Wolf.dr_closed)return!1;if(R=(E-i/2&255)>>4,R<l.state.doorMap[c][t].ticcount)return!1}t+=T}while(t!=W)}return!0}Wolf.setConsts({WALL_TILE:1,PUSHWALL_TILE:1<<20,DOOR_TILE:2,SECRET_TILE:4,DRESS_TILE:8,BLOCK_TILE:16,ACTOR_TILE:32,DEADACTOR_TILE:64,POWERUP_TILE:128,AMBUSH_TILE:256,EXIT_TILE:512,SECRETLEVEL_TILE:1024,ELEVATOR_TILE:2048,MAPHEADER_SIZE:49,MAP_SIGNATURE:558123297,TILE_IS_E_TURN:4096,TILE_IS_NE_TURN:8192,TILE_IS_N_TURN:16384,TILE_IS_NW_TURN:32768,TILE_IS_W_TURN:65536,TILE_IS_SW_TURN:1<<17,TILE_IS_S_TURN:1<<18,TILE_IS_SE_TURN:1<<19,MAX_POWERUPS:1e3}),Wolf.setConsts({SOLID_TILE:Wolf.WALL_TILE|Wolf.BLOCK_TILE|Wolf.PUSHWALL_TILE,BLOCKS_MOVE_TILE:Wolf.WALL_TILE|Wolf.BLOCK_TILE|Wolf.PUSHWALL_TILE|Wolf.ACTOR_TILE,WAYPOINT_TILE:Wolf.TILE_IS_E_TURN|Wolf.TILE_IS_NE_TURN|Wolf.TILE_IS_N_TURN|Wolf.TILE_IS_NW_TURN|Wolf.TILE_IS_W_TURN|Wolf.TILE_IS_SW_TURN|Wolf.TILE_IS_S_TURN|Wolf.TILE_IS_SE_TURN});for(var n=[[!1,-1],[!0,-1],[!0,-1],[!0,-1],[!1,-1],[!0,-1],[!1,Wolf.pow_alpo],[!0,-1],[!0,-1],[!1,-1],[!0,-1],[!0,-1],[!0,-1],[!0,-1],[!1,-1],[!1,-1],[!0,-1],[!0,-1],[!0,-1],[!1,-1],[!1,Wolf.pow_key1],[!1,Wolf.pow_key2],[!0,-1],[!1,-1],[!1,Wolf.pow_food],[!1,Wolf.pow_firstaid],[!1,Wolf.pow_clip],[!1,Wolf.pow_machinegun],[!1,Wolf.pow_chaingun],[!1,Wolf.pow_cross],[!1,Wolf.pow_chalice],[!1,Wolf.pow_bible],[!1,Wolf.pow_crown],[!1,Wolf.pow_fullheal],[!1,Wolf.pow_gibs],[!0,-1],[!0,-1],[!0,-1],[!1,Wolf.pow_gibs],[!0,-1],[!0,-1],[!1,-1],[!1,-1],[!1,-1],[!1,-1],[!0,-1],[!0,-1],[!1,-1]],S=0;S<n.length;S++){var i={idx:S,block:n[S][0],powerup:n[S][1]};n[S]=i}var T=0,p=0,E=0,I=0,R=0,L=0;return{load:r,reload:f,scanInfoPlane:c,checkLine:t}}();