Wolf.Doors=function(){function o(o){o.state.numDoors=0;for(var t=0;64>t;t++){o.state.doorMap[t]=[];for(var e=0;64>e;e++)o.state.doorMap[t][e]=0}}function t(o,t,e,r){if(o.state.numDoors>=Wolf.MAXDOORS)throw new Error("Too many Doors on level!");var a=o.state.doorMap[t][e]={type:-1,vertical:0,texture:-1,ticcount:0};switch(r){case 90:a.type=Wolf.DOOR_VERT,a.vertical=!0,a.texture=Wolf.TEX_DDOOR+1;break;case 91:a.type=Wolf.DOOR_HORIZ,a.vertical=!1,a.texture=Wolf.TEX_DDOOR;break;case 92:a.type=Wolf.DOOR_G_VERT,a.vertical=!0,a.texture=Wolf.TEX_DLOCK;break;case 93:a.type=Wolf.DOOR_G_HORIZ,a.vertical=!1,a.texture=Wolf.TEX_DLOCK;break;case 94:a.type=Wolf.DOOR_S_VERT,a.vertical=!0,a.texture=Wolf.TEX_DLOCK+1;break;case 95:a.type=Wolf.DOOR_S_HORIZ,a.vertical=!1,a.texture=Wolf.TEX_DLOCK+1;break;case 100:a.type=Wolf.DOOR_E_VERT,a.vertical=!0,a.texture=Wolf.TEX_DELEV+1;break;case 101:a.type=Wolf.DOOR_E_HORIZ,a.vertical=!1,a.texture=Wolf.TEX_DELEV;break;default:throw new Error("Unknown door type: "+r)}return a.tile={x:t,y:e},a.action=Wolf.dr_closed,o.state.doors[o.state.numDoors]=a,o.state.numDoors++,o.state.numDoors-1}function e(o){return o.action==Wolf.dr_open?Wolf.DOOR_FULLOPEN:o.ticcount}function r(o,t,e){if(t.playstate!=Wolf.ex_victory)for(var r=0;r<o.state.numDoors;++r){var a=o.state.doors[r],O={x:Wolf.TILE2POS(a.tile.x),y:Wolf.TILE2POS(a.tile.y)};switch(a.action){case Wolf.dr_closed:continue;case Wolf.dr_opening:a.ticcount>=Wolf.DOOR_FULLOPEN?(a.action=Wolf.dr_open,a.ticcount=0):(0==a.ticcount&&(Wolf.Areas.join(o,a.area1,a.area2),Wolf.Areas.connect(o,t.areanumber),o.state.areabyplayer[a.area1]&&Wolf.Sound.startSound(t.position,O,1,Wolf.CHAN_AUTO,"sfx/010.wav",1,Wolf.ATTN_STATIC,0)),a.ticcount+=e,a.ticcount>Wolf.DOOR_FULLOPEN&&(a.ticcount=Wolf.DOOR_FULLOPEN));break;case Wolf.dr_closing:a.ticcount<=0?(Wolf.Areas.disconnect(o,a.area1,a.area2),Wolf.Areas.connect(o,t.areanumber),a.ticcount=0,a.action=Wolf.dr_closed):(a.ticcount==Wolf.DOOR_FULLOPEN&&o.state.areabyplayer[a.area1]&&Wolf.Sound.startSound(t.position,O,1,Wolf.CHAN_AUTO,"sfx/007.wav",1,Wolf.ATTN_STATIC,0),a.ticcount-=e,a.ticcount<0&&(a.ticcount=0));break;case Wolf.dr_open:a.ticcount>Wolf.DOOR_MINOPEN&&(n(o,t,a.tile.x,a.tile.y,a.vertical)||(a.ticcount=Wolf.DOOR_MINOPEN)),a.ticcount>=Wolf.DOOR_TIMEOUT?(a.action=Wolf.dr_closing,a.ticcount=Wolf.DOOR_FULLOPEN):a.ticcount+=e}}}function a(o){var t,e,r,a;for(t=0;t<o.state.numDoors;++t)a=o.state.doors[t],e=a.tile.x,r=a.tile.y,a.vertical?(a.area1=o.areas[e+1][r]>=0?o.areas[e+1][r]:0,a.area2=o.areas[e-1][r]>=0?o.areas[e-1][r]:0):(a.area1=o.areas[e][r+1]>=0?o.areas[e][r+1]:0,a.area2=o.areas[e][r-1]>=0?o.areas[e][r-1]:0)}function O(o){o.action==Wolf.dr_open?o.ticcount=0:o.action=Wolf.dr_opening}function l(o,t,e){e.action<Wolf.dr_opening?O(e):e.action==Wolf.dr_open&&n(o,t,e.tile.x,e.tile.y,e.vertical)}function n(o,t,e,r,a){var O,l,n=Wolf.POS2TILE(t.position.x),f=Wolf.POS2TILE(t.position.y);if(n==e&&f==r)return!1;if(a){if(f==r){if(Wolf.POS2TILE(t.position.x+Wolf.CLOSEWALL)==e)return!1;if(Wolf.POS2TILE(t.position.x-Wolf.CLOSEWALL)==e)return!1}for(O=0;O<o.state.numGuards;++O){if(l=o.state.guards[O],l.tile.x==e&&l.tile.y==r)return!1;if(l.tile.x==e-1&&l.tile.y==r&&Wolf.POS2TILE(l.x+Wolf.CLOSEWALL)==e)return!1;if(l.tile.x==e+1&&l.tile.y==r&&Wolf.POS2TILE(l.x-Wolf.CLOSEWALL)==e)return!1}}else{if(n==e){if(Wolf.POS2TILE(t.position.y+Wolf.CLOSEWALL)==r)return!1;if(Wolf.POS2TILE(t.position.y-Wolf.CLOSEWALL)==r)return!1}for(O=0;O<o.state.numGuards;++O){var l=o.state.guards[O];if(l.tile.x==e&&l.tile.y==r)return!1;if(l.tile.x==e&&l.tile.y==r-1&&Wolf.POS2TILE(l.y+Wolf.CLOSEWALL)==r)return!1;if(l.tile.x==e&&l.tile.y==r+1&&Wolf.POS2TILE(l.y-Wolf.CLOSEWALL)==r)return!1}}return!0}function f(o,t,e){switch(e.type){case Wolf.DOOR_VERT:case Wolf.DOOR_HORIZ:case Wolf.DOOR_E_VERT:case Wolf.DOOR_E_HORIZ:l(o,t,e);break;case Wolf.DOOR_G_VERT:case Wolf.DOOR_G_HORIZ:t.items&Wolf.ITEM_KEY_1?l(o,t,e):Wolf.Game.notify("You need a gold key");break;case Wolf.DOOR_S_VERT:case Wolf.DOOR_S_HORIZ:t.items&Wolf.ITEM_KEY_2?l(o,t,e):Wolf.Game.notify("You need a silver key")}return!0}return Wolf.setConsts({CLOSEWALL:Wolf.MINDIST,MAXDOORS:64,MAX_DOORS:256,DOOR_TIMEOUT:300,DOOR_MINOPEN:50,DOOR_FULLOPEN:63,DOOR_VERT:255,DOOR_HORIZ:254,DOOR_E_VERT:253,DOOR_E_HORIZ:252,DOOR_G_VERT:251,DOOR_G_HORIZ:250,DOOR_S_VERT:249,DOOR_S_HORIZ:248,FIRST_DOOR:248,LAST_LOCK:251,TEX_DOOR:98,dr_closing:-1,dr_closed:0,dr_opening:1,dr_open:2}),Wolf.setConsts({TEX_DDOOR:0+Wolf.TEX_DOOR,TEX_PLATE:2+Wolf.TEX_DOOR,TEX_DELEV:4+Wolf.TEX_DOOR,TEX_DLOCK:6+Wolf.TEX_DOOR}),{reset:o,spawn:t,opened:e,open:O,tryUse:f,process:r,setAreas:a}}();