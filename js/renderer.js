Wolf.setConsts({FOV_RAD:75*Math.PI/180,ISCHROME:/chrome/.test(navigator.userAgent.toLowerCase()),ISSAFARI:/safari/.test(navigator.userAgent.toLowerCase()),ISFIREFOX:/firefox/.test(navigator.userAgent.toLowerCase()),ISXP:/windows nt 5\./.test(navigator.userAgent.toLowerCase()),ISWEBKIT:/webkit/.test(navigator.userAgent.toLowerCase())}),Wolf.setConsts({VIEW_DIST:Wolf.XRES/2/Math.tan(Wolf.FOV_RAD/2),TEXTURERESOLUTION:Wolf.ISCHROME?128:64}),Wolf.Renderer=function(){function e(){var e,t,r;if(!W)for(W=!0,$("#game .renderer").width(Wolf.XRES+"px").height(Wolf.YRES+"px"),r=0;r<Wolf.XRES;r+=Wolf.SLICE_WIDTH){t=$("<div>"),t.css({position:"absolute",width:Wolf.SLICE_WIDTH+"px",height:Wolf.YRES+"px",left:r+"px",top:0,overflow:"hidden"}),t.appendTo("#game .renderer"),e=h?$("<div>"):$("<img>"),e.css({position:"absolute",display:"block",top:0,height:0,width:Wolf.SLICE_WIDTH*Wolf.WALL_TEXTURE_WIDTH+"px",backgroundSize:"100% 100%"});var i=t[0];i.texture=e[0],i.appendChild(i.texture),d.push(i)}}function t(){$("#game .renderer .sprite").remove(),g=[],visibleSprites=[]}function r(e,t){var r,i,o,l,s=t.x,a=t.y,n=e.x,f=e.y,p=e.x-t.x,d=e.y-t.y,h=Math.sqrt(p*p+d*d);return h*=X(y(t.angle-e.angle)),o=L*w,i=R/h*S>>0,r=t.flags&c?t.flags&E?n>s?t.frac:1-t.frac:f>a?1-t.frac:t.frac:1-t.frac,l=r*o,l>o-w&&(l=o-w),l=C(l/w)*w,0>l&&(l=0),{w:o,h:i,dist:h,vert:t.flags&E,offset:l}}function i(){var e,t;for(e=0;e<visibleSprites.length;e++)t=visibleSprites[e].sprite,t&&t.div&&(t.div.style.display="none")}function o(e,t,r,i){for(var o,l,o=0,f=r.length;f>o;++o)l=r[o],l.oob||(l.flags&Wolf.TRACE_HIT_DOOR?a(o,e,l,t):s(o,e,l,t));n(e,t,i)}function l(e,t,r){var i,o=d[e],l=o.texture,s=o.style,a=l.style,n=(Wolf.YRES-r.h)/2,f=-r.offset>>0,p=r.h,x=u-r.dist>>0;Wolf.ISXP&&Wolf.ISFIREFOX?i=r.texture%2?0:-p:(i=-(r.texture-1)*p,t="art/walls-shaded/64/walls.png"),l._src!=t&&(l._src=t,h?a.backgroundImage="url("+t+")":l.src=t),o._zIndex!=x&&(s.zIndex=o._zIndex=x),l._height!=p&&(s.height=(l._height=p)+"px",Wolf.ISXP&&Wolf.ISFIREFOX?a.height=2*p+"px":a.height=120*p+"px"),l._itop!=i&&(a.top=(l._itop=i)+"px"),l._top!=n&&(s.top=(l._top=n)+"px"),l._left!=f&&(a.left=(l._left=f)+"px")}function s(e,t,i,o){var s,a=i.tileX,n=i.tileY,f=v(t.x),p=v(t.y),d=o.tileMap,h=r(t,i),I=h.vert?o.wallTexX[a][n]:o.wallTexY[a][n];i.flags&E?(a>=f&&d[a-1][n]&_&&(I=T),f>a&&d[a+1][n]&_&&(I=T)):(n>=p&&d[a][n-1]&_&&(I=T),p>n&&d[a][n+1]&_&&(I=T)),I++,h.texture=I,I%2==0&&I--,s=x+"w_"+I+".png",l(e,s,h)}function a(e,t,i,o){var s,a,n=r(t,i);s=o.state.doorMap[i.tileX][i.tileY].texture+1,n.texture=s,s%2==0&&(s-=1),a=x+"w_"+s+".png",l(e,a,n)}function n(e,t,r){var i,o,l,s,a,n,f,d,x,g,W,E,c;for(visibleSprites=Wolf.Sprites.createVisList(e,t,r),o=0;o<visibleSprites.length;++o)i=visibleSprites[o],l=i.dist,i.sprite.div||p(i.sprite),g=i.sprite.div,E=g.style,W=g.image,c=W.style,s=i.sprite.x-e.x,a=i.sprite.y-e.y,n=A(a,s)-y(e.angle),x=R/l*S>>0,E.display="block",E.width=x+"px",E.height=x+"px",E.left=O/2-x/2-m(n)*R+"px",E.top=b/2-x/2+"px",texture=Wolf.Sprites.getTexture(i.sprite.tex[0]),textureSrc=I+texture.sheet,W._src!=textureSrc&&(W._src=textureSrc,h?c.backgroundImage="url("+textureSrc+")":W.src=textureSrc),f=u-l>>0,d=texture.num*x,left=-texture.idx*x,g._zIndex!=f&&(E.zIndex=g._zIndex=f),W._width!=d&&(c.width=(W._width=d)+"px"),W._height!=x&&(c.height=(W._height=x)+"px"),W._left!=left&&(c.left=(W._left=left)+"px")}function f(e){e.div&&($(e.div).remove(),e.div=null)}function p(e){var t,r=document.createElement("div");r.style.display="none",r.style.position="absolute",r.style.width="128px",r.style.height="128px",r.style.overflow="hidden",r.className="sprite",t=h?$("<div>"):$("<img>"),t.css({position:"absolute",display:"block",top:0,height:"100%",width:"100%",backgroundSize:"100%",backgroundRepeat:"no-repeat"}),r.image=t[0],r.appendChild(r.image),e.div=r,$("#game .renderer").append(r)}var d=[],h=Wolf.ISWEBKIT,x="art/walls-shaded/"+Wolf.TEXTURERESOLUTION+"/",I="art/sprites/"+Wolf.TEXTURERESOLUTION+"/",g=[],u=4194304,W=!1;visibleSprites=[];var S=(Wolf.TILESHIFT,Wolf.TILEGLOBAL),E=Wolf.TRACE_HIT_VERT,c=Wolf.TRACE_HIT_DOOR,_=(Wolf.WALL_TILE,Wolf.DOOR_TILE),T=Wolf.TEX_PLATE,v=(Wolf.TILE2POS,Wolf.POS2TILE),R=Wolf.VIEW_DIST,w=Wolf.SLICE_WIDTH,L=Wolf.WALL_TEXTURE_WIDTH,y=Wolf.FINE2RAD,O=Wolf.XRES,b=Wolf.YRES,X=(Wolf.MINDIST,Math.cos),m=(Math.sin,Math.tan),A=Math.atan2,C=Math.round;Math.sqrt;return{init:e,draw:o,clear:i,loadSprite:p,unloadSprite:f,reset:t}}();